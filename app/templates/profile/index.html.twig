{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block title %}My Dashboard{% endblock %}

{% block body %}
    <div class="container-fluid mt-4">

        <div class="mb-3 d-flex justify-content-end">
            <a href="{{ path('template_create', {'id': user.id}) }}" class="btn btn-success">
                <i class="bi bi-plus-lg"></i> Create Template
            </a>
        </div>

        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab" aria-controls="templates" aria-selected="true">
                    Templates
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="forms-tab" data-bs-toggle="tab" data-bs-target="#forms" type="button" role="tab" aria-controls="forms" aria-selected="false">
                    Forms
                </button>
            </li>
        </ul>

        <div class="tab-content pt-4" id="dashboardTabsContent">
            {# Templates Tab #}
            <div class="tab-pane fade show active" id="templates" role="tabpanel" aria-labelledby="templates-tab">
                <div class="mb-2">
                    <button id="bulkDeleteBtn" class="btn btn-danger btn-sm" disabled>
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="templateTable" class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Template ID</th>
                            <th>Title</th>
                            <th>Image</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            {# My Filled Forms Tab #}
            <div class="tab-pane fade" id="forms" role="tabpanel" aria-labelledby="forms-tab">
                <div class="mb-2">
                    <button id="bulkFormDeleteBtn" class="btn btn-danger btn-sm" disabled>
                        <i class="bi bi-trash-fill"></i> Delete
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="formTable" class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="formSelectAll"></th>
                            <th >Form ID</th>
                            <th>Form Title</th>
                            <th>Submitted At</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete <span id="deleteCount"></span> selected <span id="deleteType"></span>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="confirmDeleteBtn" type="button" class="btn btn-danger">Yes, Delete</button>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        $(document).ready(function () {
            const table = $('#templateTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: "{{ path('template_ajax_user', { userId: user.id }) }}",
                order: [[1, 'asc']],
                columns: [
                    {
                        data: 'id',
                        orderable: false,
                        searchable: false,
                        render: function (data) {
                            return `<input type="checkbox" class="row-checkbox" value="${data}">`;
                        }
                    },
                    {data: 'id', orderable: true, searchable: false},
                    {data: 'title'},
                    {data: 'image', orderable: false, searchable: false},
                    {
                        data: 'description',
                        orderable: false,
                        render: function (data, type) {
                            if (type === 'display') {
                                const html = marked.parse(data || '');
                                const div = document.createElement('div');
                                div.innerHTML = html;
                                const text = div.textContent || div.innerText || '';
                                const shortText = text.length > 100 ? text.substring(0, 50) + 'â€¦' : text;
                                return shortText;
                            }
                            return data;
                        }
                    },
                    {
                        data: 'actions',
                        orderable: false,
                        searchable: false,
                        visible: false,
                        render: function (data) {
                            return `
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#">Edit</a></li>
                                    <li><a class="dropdown-item" href="#">Fill</a></li>
                                    <li><a class="dropdown-item text-danger" href="#">Delete</a></li>
                                </ul>
                            </div>`;
                        }
                    }

                ],
                createdRow: function (row, data) {
                    const editUrlTemplate = "{{ path('template_edit', { id: '__ID__' }) }}";
                    const editUrl = editUrlTemplate.replace('__ID__', data.id);
                    $(row).attr('data-href', editUrl);
                    $(row).css('cursor', 'pointer');
                }
            });

            // Select/Deselect all
            $('#selectAll').on('click', function () {
                const checked = this.checked;
                $('.row-checkbox').prop('checked', checked);
                $('#bulkDeleteBtn').prop('disabled', $('.row-checkbox:checked').length === 0);
            });

            // Toggle delete button based on selection
            $(document).on('change', '.row-checkbox', function () {
                const allChecked = $('.row-checkbox').length === $('.row-checkbox:checked').length;
                $('#selectAll').prop('checked', allChecked);
                $('#bulkDeleteBtn').prop('disabled', $('.row-checkbox:checked').length === 0);
            });

            let deleteIds = [];
            let deleteMode = ''; // 'template' or 'form'


            $('#bulkDeleteBtn, #bulkFormDeleteBtn').on('click', function () {
                if (this.id === 'bulkDeleteBtn') {
                    deleteIds = $('.row-checkbox:checked').map(function () {
                        return $(this).val();
                    }).get();
                    deleteMode = 'template';
                } else {
                    deleteIds = $('.form-checkbox:checked').map(function () {
                        return $(this).val();
                    }).get();
                    deleteMode = 'form';
                }

                if (deleteIds.length === 0) return;

                $('#deleteCount').text(deleteIds.length);
                $('#deleteType').text(deleteMode === 'template' ? 'template(s)' : 'form(s)');
                new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
            });

            $('#confirmDeleteBtn').on('click', function () {
                const url = deleteMode === 'template'
                    ? "{{ path('template_bulk_delete') }}"
                    : "/form/bulk-delete";

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify({ ids: deleteIds }),
                    contentType: 'application/json',
                    success: function () {
                        if (deleteMode === 'template') {
                            $('#templateTable').DataTable().ajax.reload(null, false);
                            $('#selectAll').prop('checked', false);
                            $('#bulkDeleteBtn').prop('disabled', true);
                        } else {
                            $('#formTable').DataTable().ajax.reload(null, false);
                            $('#formSelectAll').prop('checked', false);
                            $('#bulkFormDeleteBtn').prop('disabled', true);
                        }

                        bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();

                        // Show toast after successful delete
                        const toastHTML = `
        <div class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Selected ${deleteMode === 'template' ? 'templates' : 'forms'} deleted successfully.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

                        const container = document.querySelector('.toast-container');
                        container.insertAdjacentHTML('beforeend', toastHTML);

                        const newToast = container.lastElementChild;
                        new bootstrap.Toast(newToast).show();

                        // Hide modal
                        const modalEl = document.getElementById('confirmDeleteModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    },
                    error: function () {
                        console.log('Error deleting selected items.');
                    }
                });
            });


        });
    </script>

    {# myfiledforms script#}
    <script>
        $(document).ready(function () {
            const formTable = $('#formTable').DataTable({
                processing: true,
                serverSide: true,
                order: [[3, 'desc']],
                ajax: {
                    url: "{{ path('form_list', { userId: user.id }) }}",
                    type: 'GET',
                },
                columns: [
                    {
                        data: 'id',
                        orderable: false,
                        searchable: false,
                        render: function (data) {
                            return `<input type="checkbox" class="form-checkbox" value="${data}">`;
                        }
                    },
                    { data: 'id' },
                    { data: 'template' },
                    { data: 'submittedAt' },
                    {
                        data: 'id',
                        orderable: false,
                        searchable: false,
                        visible: false,
                        render: function(data) {
                            return `
                            <a href="/form/${data}/view" class="btn btn-sm btn-primary">View</a>
                            <a href="/form/${data}/edit" class="btn btn-sm btn-secondary">Edit</a>
                        `;
                        }
                    }
                ],
                createdRow: function (row, data) {
                    $(row).attr('data-href', `/form/${data.id}/edit`);
                    $(row).css('cursor', 'pointer');
                }
            });

            // Prevent row click when interacting with checkbox/buttons
            $(document).on('click', '#formTable tbody tr', function (e) {
                if (
                    $(e.target).is('a, button, i, input[type="checkbox"], .form-checkbox') ||
                    $(e.target).closest('.dropdown').length
                ) return;

                const href = $(this).attr('data-href');
                if (href) {
                    window.location.href = href;
                }
            });

            // Select/Deselect All
            $('#formSelectAll').on('click', function () {
                const checked = this.checked;
                $('.form-checkbox').prop('checked', checked);
                $('#bulkFormDeleteBtn').prop('disabled', $('.form-checkbox:checked').length === 0);
            });

            // Enable/Disable Delete Button
            $(document).on('change', '.form-checkbox', function () {
                const allChecked = $('.form-checkbox').length === $('.form-checkbox:checked').length;
                $('#formSelectAll').prop('checked', allChecked);
                $('#bulkFormDeleteBtn').prop('disabled', $('.form-checkbox:checked').length === 0);
            });

            let deleteIds = [];
            let deleteMode = ''; // 'template' or 'form'

            $('#confirmDeleteBtn').on('click', function () {
                const url = deleteMode === 'template'
                    ? "{{ path('template_bulk_delete') }}"
                    : "/form/bulk-delete";

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify({ ids: deleteIds }),
                    contentType: 'application/json',
                    success: function () {
                        if (deleteMode === 'template') {
                            $('#templateTable').DataTable().ajax.reload(null, false);
                            $('#selectAll').prop('checked', false);
                            $('#bulkDeleteBtn').prop('disabled', true);
                        } else {
                            $('#formTable').DataTable().ajax.reload(null, false);
                            $('#formSelectAll').prop('checked', false);
                            $('#bulkFormDeleteBtn').prop('disabled', true);
                        }

                        // Show toast after successful delete
                        const toastHTML = `
        <div class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Selected ${deleteMode === 'template' ? 'templates' : 'forms'} deleted successfully.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

                        const container = document.querySelector('.toast-container');
                        container.insertAdjacentHTML('beforeend', toastHTML);

                        const newToast = container.lastElementChild;
                        new bootstrap.Toast(newToast).show();

                        // Hide modal
                        const modalEl = document.getElementById('confirmDeleteModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    },
                    error: function () {
                        console.log('Error deleting selected items.');
                    }
                });
            });



        });
    </script>

    <script>

        $(document).on('click', 'table tbody tr', function (e) {
            // Prevent row click if clicking inside interactive elements
            if (
                $(e.target).is('a, button, i, input[type="checkbox"], .row-checkbox') ||
                $(e.target).closest('.dropdown').length
            ) {
                return; // Do nothing
            }

            const href = $(this).attr('data-href');
            if (href) {
                window.location.href = href;
            }
        });
    </script>

{% endblock %}

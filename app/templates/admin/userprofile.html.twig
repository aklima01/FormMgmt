{# templates/user/dashboard.html.twig #}

{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block title %}My Dashboard{% endblock %}

{% block body %}
    <div class="container-fluid mt-4">

        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab" aria-controls="templates" aria-selected="true">
                    Templates
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="forms-tab" data-bs-toggle="tab" data-bs-target="#forms" type="button" role="tab" aria-controls="forms" aria-selected="false">
                    Filled Forms
                </button>
            </li>
        </ul>

        <div class="tab-content pt-4" id="dashboardTabsContent">
            {# My Templates Tab #}
            {# Add Delete Button + Table #}
            <div class="tab-pane fade show active" id="templates" role="tabpanel" aria-labelledby="templates-tab">
                <div class="mb-2">
                    <button id="bulkDeleteBtn" class="btn btn-danger btn-sm" disabled>
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="templateTable" class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Template ID</th>
                            <th>Title</th>
                            <th>Image</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            {# My Filled Forms Tab #}
            <div class="tab-pane fade" id="forms" role="tabpanel" aria-labelledby="forms-tab">
                <div class="mb-2">
                    <button id="bulkFormDeleteBtn" class="btn btn-danger btn-sm" disabled>
                        <i class="bi bi-trash-fill"></i> Delete
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="formTable" class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="formSelectAll"></th>
                            <th >Form ID</th>
                            <th>Form Title</th>
                            <th>Submitted At</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>


        </div>
    </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        $(document).ready(function () {
            const table = $('#templateTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: "{{ path('template_ajax_user', { userId: user.id }) }}",
                order: [[0, 'desc']],
                columns: [
                    {
                        data: 'id',
                        orderable: true,
                        searchable: false,
                        render: function (data) {
                            return `<input type="checkbox" class="row-checkbox" value="${data}">`;
                        }
                    },
                    {data: 'id'},
                    {data: 'title'},
                    {data: 'image', orderable: false, searchable: false},
                    {
                        data: 'description',
                        render: function (data, type) {
                            return type === 'display' ? marked.parse(data || '') : data;
                        }
                    },
                    {
                        data: 'actions',
                        orderable: false,
                        searchable: false,
                        visible: false,
                        render: function (data) {
                            return `
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="${data.editUrl}">Edit</a></li>
                                    <li><a class="dropdown-item" href="${data.fillUrl}">Fill</a></li>
                                    <li><a class="dropdown-item text-danger" href="${data.deleteUrl}">Delete</a></li>
                                </ul>
                            </div>`;
                        }
                    }
                ],
                createdRow: function (row, data) {
                    $(row).attr('data-href', data.actions.editUrl);
                    $(row).css('cursor', 'pointer');
                }
            });

            // Select/Deselect all
            $('#selectAll').on('click', function () {
                const checked = this.checked;
                $('.row-checkbox').prop('checked', checked);
                $('#bulkDeleteBtn').prop('disabled', $('.row-checkbox:checked').length === 0);
            });

            // Toggle delete button based on selection
            $(document).on('change', '.row-checkbox', function () {
                const allChecked = $('.row-checkbox').length === $('.row-checkbox:checked').length;
                $('#selectAll').prop('checked', allChecked);
                $('#bulkDeleteBtn').prop('disabled', $('.row-checkbox:checked').length === 0);
            });

            // Bulk delete action
            $('#bulkDeleteBtn').on('click', function () {
                const ids = $('.row-checkbox:checked').map(function () {
                    return $(this).val();
                }).get();

                if (ids.length === 0) return;

                // if (!confirm(`Are you sure you want to delete ${ids.length} item(s)?`)) return;

                $.ajax({
                    url: "{{ path('template_bulk_delete') }}",
                    type: 'POST',
                    data: JSON.stringify({ ids: ids }),
                    contentType: 'application/json',
                    success: function () {
                        table.ajax.reload(null, false);
                        $('#selectAll').prop('checked', false);
                        $('#bulkDeleteBtn').prop('disabled', true);
                    },
                    error: function () {
                        alert('Error deleting templates.');
                    }
                });
            });
        });
    </script>



    {# myfiledforms script#}
    <script>
        $(document).ready(function () {
            const formTable = $('#formTable').DataTable({
                processing: true,
                serverSide: true,
                order: [[3, 'desc']],
                ajax: {
                    url: "{{ path('form_ajax_user', { userId: user.id }) }}",
                    type: 'GET',
                },
                columns: [
                    {
                        data: 'id',
                        orderable: false,
                        searchable: false,
                        render: function (data) {
                            return `<input type="checkbox" class="form-checkbox" value="${data}">`;
                        }
                    },
                    { data: 'id' },
                    { data: 'template' },
                    { data: 'submittedAt' },
                    {
                        data: 'id',
                        orderable: false,
                        searchable: false,
                        visible: false,
                        render: function(data) {
                            return `
                            <a href="/form/${data}/view" class="btn btn-sm btn-primary">View</a>
                            <a href="/form/${data}/edit" class="btn btn-sm btn-secondary">Edit</a>
                        `;
                        }
                    }
                ],
                createdRow: function (row, data) {
                    $(row).attr('data-href', `/form/${data.id}/edit`);
                    $(row).css('cursor', 'pointer');
                }
            });

            // Prevent row click when interacting with checkbox/buttons
            $(document).on('click', '#formTable tbody tr', function (e) {
                if (
                    $(e.target).is('a, button, i, input[type="checkbox"], .form-checkbox') ||
                    $(e.target).closest('.dropdown').length
                ) return;

                const href = $(this).attr('data-href');
                if (href) {
                    window.location.href = href;
                }
            });

            // Select/Deselect All
            $('#formSelectAll').on('click', function () {
                const checked = this.checked;
                $('.form-checkbox').prop('checked', checked);
                $('#bulkFormDeleteBtn').prop('disabled', $('.form-checkbox:checked').length === 0);
            });

            // Enable/Disable Delete Button
            $(document).on('change', '.form-checkbox', function () {
                const allChecked = $('.form-checkbox').length === $('.form-checkbox:checked').length;
                $('#formSelectAll').prop('checked', allChecked);
                $('#bulkFormDeleteBtn').prop('disabled', $('.form-checkbox:checked').length === 0);
            });

            // Bulk Delete
            $('#bulkFormDeleteBtn').on('click', function () {
                const ids = $('.form-checkbox:checked').map(function () {
                    return $(this).val();
                }).get();

                if (ids.length === 0) return;

                // if (!confirm(`Are you sure you want to delete ${ids.length} form(s)?`)) return;

                $.ajax({
                    url: "/form/bulk-delete",
                    type: 'POST',
                    data: JSON.stringify({ ids: ids }),
                    contentType: 'application/json',
                    success: function () {
                        formTable.ajax.reload(null, false);
                        $('#formSelectAll').prop('checked', false);
                        $('#bulkFormDeleteBtn').prop('disabled', true);
                    },
                    error: function () {
                        alert('Error deleting forms.');
                    }
                });
            });
        });
    </script>

    <script>

        $(document).on('click', 'table tbody tr', function (e) {
            // Prevent row click if clicking inside interactive elements
            if (
                $(e.target).is('a, button, i, input[type="checkbox"], .row-checkbox') ||
                $(e.target).closest('.dropdown').length
            ) {
                return; // Do nothing
            }

            const href = $(this).attr('data-href');
            if (href) {
                window.location.href = href;
            }
        });

    </script>






{% endblock %}

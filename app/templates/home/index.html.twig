{% extends 'base.html.twig' %}

{% block title %}Home Page{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Show pointer cursor on row hover */
        #popularTemplatesTable tbody tr:hover {
            cursor: pointer;
        }
    </style>

    <style>
        #latest-templates tbody tr {
            cursor: pointer;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <div class="col-md-8 offset-md-2">


        <!-- Latest Templates (in Table Format) -->
        <section class="mb-5">
            <h2>Latest Templates</h2>
            <table class="table  table-hover" id="latest-templates">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Author</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </section>

        <!-- Top 5 Most Popular Templates -->
        <section class="mb-5">
            <h2>Top 5 Most Popular Templates</h2>
            <table class="table table-hover" id="popularTemplatesTable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Template Name</th>
                    <th>Description</th>
                    <th>Author</th>
                    <th>Filled Forms</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </section>

        <!-- Tag Cloud (Simple Badge List) -->
            <section id="popular-tags">
                <h2>Tags</h2>
                <div id="tag-badges"></div>
            </section>

        </div>

    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Home page scripts loaded.');
            const table = $('#latest-templates').DataTable({
                processing: false,
                serverSide: false,
                lengthChange: false,
                searching: false,
                responsive: true,
                info: false,
                paging: false,
                ordering: false,
                ajax: {
                    url: '{{ path('template_latest_ajax') }}',
                    type: 'GET',
                    dataSrc: 'data',
                    data: function (d) {
                        return d;
                    }
                },
                columns: [
                    { data: 'id', title: 'ID', visible: false }, // hidden ID
                    { data: 'title', title: 'Title' },
                    {
                        data: 'description',
                        title: 'Description',
                        render: function (data, type, row, meta) {
                            if (type === 'display' && data.length > 50) {
                                return data.substr(0, 50) + '…';
                            }
                            return data;
                        }
                    },
                    { data: 'author', title: 'Author' }
                ],
                order: [[0, 'desc']],
                pageLength: 10,
            });

            // Add click event to rows
            $('#latest-templates tbody').on('click', 'tr', function () {
                const data = table.row(this).data();
                if (data && data.id) {
                    window.location.href = `/template/${data.id}/fill`;
                }
            });

            $('#popularTemplatesTable').DataTable({
                ajax: {
                    url: '{{ path('template_popular_ajax') }}',
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'id', title: 'ID', visible: false },
                    { data: 'title', title: 'Title' },
                    {
                        data: 'description',
                        title: 'Description',
                        render: function (data, type, row, meta) {
                            if (type === 'display' && data.length > 50) {
                                return data.substr(0, 50) + '…';
                            }
                            return data;
                        }
                    },
                    { data: 'author', title: 'Author' },
                    { data: 'filledForms', title: 'Filled', visible: false },
                ],
                ordering: false,
                searching: false,
                paging: false,
                info: false
            });

            // Make rows clickable
            $('#popularTemplatesTable tbody').on('click', 'tr', function () {
                const data = table.row(this).data();
                if (data && data.id) {
                    window.location.href = `/template/${data.id}/fill`;
                }
            });

            $.ajax({
                url: '{{ path('tags_popular_ajax') }}',
                method: 'GET',
                success: function (response) {
                    const tags = response.data;
                    const bgColors = [
                        'bg-primary',
                        'bg-secondary',
                        'bg-success',
                        'bg-danger',
                        'bg-warning',
                        'bg-info',
                        'bg-dark'
                    ];
                    let html = '';
                    tags.forEach((tag, index) => {
                        const colorClass = bgColors[index % bgColors.length];
                        html += `
                        <a href="/search?q=${encodeURIComponent(tag.name.toLowerCase())}"
                           class="badge text-white ${colorClass} me-1 mb-1"
                           style="font-size: 1rem;">
                            ${tag.name}
                        </a>
                    `;
                    });
                    $('#tag-badges').html(html);
                },
                error: function () {
                    $('#tag-badges').html('<span class="text-danger">Failed to load tags.</span>');
                }
            });

            $('#latest-templates tbody').on('mouseenter', 'tr', function () {
                $(this).css('cursor', 'pointer');
            });
            //end
        });
    </script>


{% endblock %}
